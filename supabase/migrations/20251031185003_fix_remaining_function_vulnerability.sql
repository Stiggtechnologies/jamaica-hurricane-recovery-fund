/*
  # Fix Remaining Function Vulnerability
  
  Fix the overloaded calculate_relevance_score function that was missed
*/

DROP FUNCTION IF EXISTS public.calculate_relevance_score(text, text, text) CASCADE;

CREATE FUNCTION public.calculate_relevance_score(p_title text, p_description text, p_content text)
RETURNS NUMERIC
LANGUAGE plpgsql
IMMUTABLE
SECURITY DEFINER
SET search_path = ''
AS $$
DECLARE
  score NUMERIC := 0;
  combined_text TEXT;
  keywords TEXT[] := ARRAY['jamaica', 'hurricane', 'disaster', 'relief', 'recovery', 'rebuild', 'beryl', 'climate'];
  keyword TEXT;
BEGIN
  combined_text := COALESCE(p_title, '') || ' ' || COALESCE(p_description, '') || ' ' || COALESCE(p_content, '');
  
  FOREACH keyword IN ARRAY keywords LOOP
    IF combined_text ILIKE '%' || keyword || '%' THEN
      score := score + 1;
    END IF;
  END LOOP;
  
  RETURN score;
END;
$$;
